function getBoxAt(a,b,c){return c.find(d=>d.gridX===a&&d.gridY===b)}function drawGrid(a,b,c,d){a.strokeStyle="rgba(0, 0, 0, 0.1)";for(var f=0;f<=b/d;f++)a.beginPath(),a.moveTo(f*d,0),a.lineTo(f*d,c),a.stroke();for(f=0;f<=c/d;f++)a.beginPath(),a.moveTo(0,f*d),a.lineTo(b,f*d),a.stroke()};function setCookie(a,b,c){var d="";c&&(d=new Date,d.setTime(d.getTime()+864E5*c),d="; expires="+d.toUTCString());document.cookie=a+"="+(b||"")+d+"; path=/"}function getCookie(a){a+="=";const b=document.cookie.split(";");for(let c=0;c<b.length;c++){let d=b[c];for(;" "===d.charAt(0);)d=d.substring(1,d.length);if(0===d.indexOf(a))return d.substring(a.length,d.length)}return null}function eraseCookie(a){document.cookie=a+"=; Path=/; Expires=Thu, 01 Jan 1970 00:00:01 GMT;"};const AUDIO={backgroundMusic:new Audio("sounds/background_music.mp3"),shoot:new Audio("sounds/shoot.wav"),loose:new Audio("sounds/loose.wav"),match:new Audio("sounds/match.wav"),line:new Audio("sounds/line.wav"),heartbeat:new Audio("sounds/heartbeat.wav")};let isSoundOn=!0;const BACKGROUND_MUSIC_VOLUME=.5;AUDIO.backgroundMusic.loop=!0;AUDIO.backgroundMusic.volume=BACKGROUND_MUSIC_VOLUME;function playSound(a){isSoundOn&&(a.currentTime=0,a.play().catch(b=>console.error("Error playing sound:",b)))}
function startBackgroundMusic(){isSoundOn&&AUDIO.backgroundMusic.play().catch(a=>console.error("Error playing background music:",a))}function stopBackgroundMusic(){AUDIO.backgroundMusic.pause();AUDIO.backgroundMusic.currentTime=0}function toggleSound(){(isSoundOn=!isSoundOn)?startBackgroundMusic():stopBackgroundMusic()}function setBackgroundMusicVolume(a){AUDIO.backgroundMusic.volume=Math.max(0,Math.min(1,a))}setBackgroundMusicVolume(.1);const startButton=document.getElementById("startButton"),canvas=document.getElementById("gameCanvas"),ctx=canvas.getContext("2d");startButton.addEventListener("click",()=>{startButton.style.display="none";canvas.style.display="block";initGame();startBackgroundMusic();lastTime=performance.now();animationFrameId=requestAnimationFrame(gameLoop)});const backgroundImages="images/background1.png images/background2.png images/background3.png images/background4.png images/background5.png images/background6.png images/background7.png images/background8.png images/background9.png images/background10.png images/background11.png images/background12.png images/background13.png".split(" ");
function changeBackground(){currentBackgroundIndex=(currentBackgroundIndex+1)%backgroundImages.length;canvas.style.backgroundImage=`url('${backgroundImages[currentBackgroundIndex]}')`}const WIDTH=640,HEIGHT=480,BOX_SIZE=40,PLAYER_SIZE=BOX_SIZE,CRANE_WIDTH=80,CRANE_HEIGHT=20,GRID_WIDTH=Math.floor(WIDTH/BOX_SIZE),GRID_HEIGHT=Math.floor(HEIGHT/BOX_SIZE);canvas.width=WIDTH;canvas.height=HEIGHT;
let player,crane,boxes=[],bullets=[],gameOver=!1,score=0,level=1,lastLifeBonus=0,isPaused=!1,animationFrameId=null,lastTime=0,currentBackgroundIndex=0,gameInProgress=!1,highScore=parseInt(getCookie("highScore"))||0;
function initGame(){player=new Player(Math.floor(GRID_WIDTH/2),GRID_HEIGHT-1);crane=new Crane;boxes=[];bullets=[];gameOver=!1;score=0;level=1;lastLifeBonus=0;isPaused=!1;gameInProgress=!0;startBackgroundMusic();canvas.style.backgroundImage=`url('${backgroundImages[currentBackgroundIndex]}')`;highScore=parseInt(getCookie("highScore"))||0}
document.addEventListener("keydown",a=>{if("KeyM"===a.code)toggleSound();else if("KeyS"===a.code&&gameOver)initGame(),changeBackground(),animationFrameId=requestAnimationFrame(gameLoop);else if(("KeyP"===a.code||"KeyH"===a.code)&&gameInProgress)(isPaused=!isPaused)?(animationFrameId&&(cancelAnimationFrame(animationFrameId),animationFrameId=null),stopBackgroundMusic(),drawPauseScreen()):(animationFrameId||=requestAnimationFrame(gameLoop),startBackgroundMusic());else if(!isPaused)switch(a.code){case "ArrowLeft":case "KeyA":player.move(-1,
boxes);break;case "ArrowRight":case "KeyD":player.move(1,boxes);break;case "Space":case "KeyW":case "ArrowUp":player.jump();break;case "Comma":if(a=player.shoot(-1))bullets.push(a),playSound(AUDIO.shoot);break;case "Period":if(a=player.shoot(1))bullets.push(a),playSound(AUDIO.shoot)}});function updateHighScore(){score>highScore&&(highScore=score,setCookie("highScore",highScore,365))}
function drawPauseScreen(){ctx.fillStyle="rgba(0, 0, 0, 0.5)";ctx.fillRect(0,0,WIDTH,HEIGHT);ctx.fillStyle="white";ctx.font="30px Arial";ctx.textAlign="center";ctx.fillText("PAUSE",WIDTH/2,HEIGHT/2);ctx.font="20px Arial";ctx.fillText('Press "H" or "P" for pause',WIDTH/2,HEIGHT/2+40);ctx.fillText('Press "M" for mute/unmute',WIDTH/2,HEIGHT/2+70);ctx.fillText('"A/D/Arrow keys" for moves left and right',WIDTH/2,HEIGHT/2+100);ctx.fillText('"W/Space/Up Arrow key" for jump',WIDTH/2,HEIGHT/2+130);ctx.fillText('"</>" for shoot left and right',
WIDTH/2,HEIGHT/2+160)}function removeBoxAndUpdateStack(a){boxes=boxes.filter(b=>b!==a);boxes.filter(b=>b.gridX===a.gridX&&b.gridY<a.gridY).forEach(b=>{b.gridY++;b.falling=!0})}function checkAndClearLines(){let a=0;for(let b=GRID_HEIGHT-1;0<=b;b--)boxes.filter(c=>c.gridY===b).length===GRID_WIDTH&&(boxes=boxes.filter(c=>c.gridY!==b),boxes.forEach(c=>{c.gridY<b&&(c.gridY++,c.falling=!0)}),a++,playSound(AUDIO.line),b++);score+=5*a;checkLevelUp();checkLifeBonus()}
function checkAndClearMatches(){let a=new Set;for(let f=0;f<GRID_HEIGHT;f++)for(let g=0;g<GRID_WIDTH-2;g++){var b=boxes.find(e=>e.gridX===g&&e.gridY===f&&"normal"===e.type&&!e.falling),c=boxes.find(e=>e.gridX===g+1&&e.gridY===f&&"normal"===e.type&&!e.falling),d=boxes.find(e=>e.gridX===g+2&&e.gridY===f&&"normal"===e.type&&!e.falling);b&&c&&d&&b.color===c.color&&c.color===d.color&&(a.add(b),a.add(c),a.add(d))}for(let f=0;f<GRID_WIDTH;f++)for(let g=0;g<GRID_HEIGHT-2;g++)b=boxes.find(e=>e.gridX===f&&
e.gridY===g&&"normal"===e.type&&!e.falling),c=boxes.find(e=>e.gridX===f&&e.gridY===g+1&&"normal"===e.type&&!e.falling),d=boxes.find(e=>e.gridX===f&&e.gridY===g+2&&"normal"===e.type&&!e.falling),b&&c&&d&&b.color===c.color&&c.color===d.color&&(a.add(b),a.add(c),a.add(d));0<a.size&&(boxes=boxes.filter(f=>!a.has(f)),playSound(AUDIO.match),boxes.forEach(f=>{const g=Array.from(a).filter(e=>e.gridX===f.gridX&&e.gridY>f.gridY);f.gridY+=g.length;f.falling=!0}),score+=3*a.size,checkLevelUp(),checkLifeBonus())}
function checkLevelUp(){score>=20*level&&(level++,crane.increaseSpeed())}function checkLifeBonus(){100<=score-lastLifeBonus&&(player.addLife(),lastLifeBonus=score-score%100)}function drawScore(){ctx.save();ctx.fillStyle="white";ctx.font="bold 16px Arial";ctx.textAlign="left";ctx.textBaseline="top";ctx.fillStyle="rgba(0, 0, 0, 0.2)";ctx.fillRect(10,22,120,46);ctx.fillStyle="white";ctx.fillText(`Score: ${score}`,16,28);ctx.fillText(`Level: ${level}`,16,48);ctx.restore()}
function drawGameOverScreen(){ctx.fillStyle="rgba(0, 0, 0, 0.7)";ctx.fillRect(0,0,WIDTH,HEIGHT);ctx.fillStyle="white";ctx.font="30px Arial";ctx.textAlign="center";ctx.fillText("GAME OVER!",WIDTH/2,HEIGHT/2-60);ctx.fillText(`Final score: ${score}`,WIDTH/2,HEIGHT/2-20);ctx.fillText(`High Score: ${highScore}`,WIDTH/2,HEIGHT/2+20);ctx.font="20px Arial";ctx.fillText('Press "S" for restart game',WIDTH/2,HEIGHT/2+60)}
function gameLoop(a){const b=(a-lastTime)/1E3;lastTime=a;gameOver?(stopBackgroundMusic(),drawGameOverScreen(),updateHighScore()):(isPaused?drawPauseScreen():(ctx.clearRect(0,0,WIDTH,HEIGHT),player.update(boxes,b),(a=crane.update(boxes,b))&&boxes.push(a),boxes=boxes.filter(c=>!c.update(boxes,player,b)),bullets=bullets.filter(c=>{c.update(b);const d=c.checkCollision(boxes);return d?(removeBoxAndUpdateStack(d),!1):0<=c.gridX&&c.gridX<GRID_WIDTH}),checkAndClearLines(),checkAndClearMatches(),ctx.fillStyle=
"rgba(255, 255, 255, 0.1)",ctx.fillRect(0,0,WIDTH,HEIGHT),drawGrid(ctx,WIDTH,HEIGHT,BOX_SIZE),boxes.forEach(c=>c.draw(ctx)),player.draw(ctx),crane.draw(ctx),bullets.forEach(c=>c.draw(ctx)),drawScore()),animationFrameId=requestAnimationFrame(gameLoop))};class Player{constructor(a,b){this.gridX=a;this.gridY=b;this.x=this.gridX*BOX_SIZE;this.y=this.gridY*BOX_SIZE;this.height=this.width=BOX_SIZE;this.velocityY=0;this.jumpSpeed=-500;this.gravity=1E3;this.jumping=!1;this.lives=5;this.invulnerable=!1;this.invulnerabilityTime=0;this.invulnerabilityDuration=2;this.hasBullet=!1}move(a,b){const c=this.gridX+a;if(0<=c&&c<GRID_WIDTH){const d=this.getBoxAt(c,this.gridY,b);d?this.canPushBox(d,a,b)&&(this.pushBox(d,a,b),this.gridX=c,this.x=this.gridX*BOX_SIZE):
(this.gridX=c,this.x=this.gridX*BOX_SIZE)}}jump(){this.jumping||(this.velocityY=this.jumpSpeed,this.jumping=!0)}shoot(a){if(!this.hasBullet)return null;this.hasBullet=!1;return new Bullet(this.gridX,this.gridY,a)}getBoxAt(a,b,c){return c.find(d=>d.gridX===a&&d.gridY===b)}update(a,b){this.velocityY+=this.gravity*b;this.y+=this.velocityY*b;if(this.y>this.gridY*BOX_SIZE){if(this.getBoxAt(this.gridX,this.gridY+1,a)||this.gridY>=GRID_HEIGHT-1)this.y=this.gridY*BOX_SIZE,this.velocityY=0,this.jumping=!1}else(a=
this.getBoxAt(this.gridX,this.gridY-1,a))&&this.y<=a.y+BOX_SIZE&&(this.y=this.gridY*BOX_SIZE,this.velocityY=0);this.gridY=Math.floor(this.y/BOX_SIZE);this.invulnerable&&(this.invulnerabilityTime+=b,this.invulnerabilityTime>=this.invulnerabilityDuration&&(this.invulnerable=!1,this.invulnerabilityTime=0))}canPushBox(a,b,c){b=a.gridX+b;return 0<=b&&b<GRID_WIDTH&&!getBoxAt(b,a.gridY,c)&&!getBoxAt(a.gridX,a.gridY-1,c)}pushBox(a,b,c){a.gridX+=b;a.x=a.gridX*BOX_SIZE;!getBoxAt(a.gridX,a.gridY+1,c)&&a.gridY<
GRID_HEIGHT-1&&(a.falling=!0)}addLife(){10>this.lives&&(this.lives++,playSound(AUDIO.heartbeat))}loseLife(){this.invulnerable||(this.lives--,playSound(AUDIO.loose),this.invulnerable=!0,this.invulnerabilityTime=0,0>=this.lives&&(gameOver=!0,gameInProgress=!1))}drawHeart(a,b,c,d,f){a.fillStyle=f;a.beginPath();a.moveTo(b,c+d/4);a.bezierCurveTo(b,c,b-d/2,c,b-d/2,c+d/4);a.bezierCurveTo(b-d/2,c+d/2,b,c+d/2,b,c+3*d/4);a.bezierCurveTo(b,c+d/2,b+d/2,c+d/2,b+d/2,c+d/4);a.bezierCurveTo(b+d/2,c,b,c,b,c+d/4);
a.fill()}draw(a){a.fillStyle=this.invulnerable?"rgba(0, 0, 255, 0.5)":"blue";a.fillRect(this.x,this.y,this.width,this.height);for(var b=0;b<this.lives;b++)this.drawHeart(a,25+30*b,5,20,"green");this.hasBullet&&(b=WIDTH-25,a.fillStyle="#CD7F32",a.beginPath(),a.arc(b,25,10,0,2*Math.PI),a.fill(),a.fillStyle="#DFA76C",a.beginPath(),a.arc(b-3,22,4,0,2*Math.PI),a.fill())}};class Crane{constructor(){this.gridX=GRID_WIDTH;this.x=this.gridX*BOX_SIZE;this.y=0;this.width=CRANE_WIDTH;this.height=CRANE_HEIGHT;this.speed=this.baseSpeed=150;this.direction=-1;this.hasBox=!0;this.dropPoint=Math.floor(Math.random()*GRID_WIDTH);this.boxType=this.getRandomBoxType();this.boxColor=this.getRandomBoxColor()}update(a,b){this.x+=this.speed*this.direction*b;this.gridX=Math.floor(this.x/BOX_SIZE);-2>=this.gridX&&(this.gridX=GRID_WIDTH,this.x=this.gridX*BOX_SIZE,this.hasBox=!0,this.dropPoint=
Math.floor(Math.random()*GRID_WIDTH),this.boxType=this.getRandomBoxType(),this.boxColor=this.getRandomBoxColor());return this.hasBox&&Math.floor(this.x/BOX_SIZE)===this.dropPoint&&!a.some(c=>c.gridX===this.dropPoint&&0===c.gridY)?(this.hasBox=!1,new Box(this.dropPoint,0,this.boxType,this.boxColor)):null}getRandomBoxType(){const a=Math.random();return.1>a?"bonus":.2>a?"bullet":"normal"}getRandomBoxColor(){const a=["red","lime","green","purple"];return a[Math.floor(Math.random()*a.length)]}increaseSpeed(){this.speed=
this.baseSpeed*(1+.1*(level-1))}draw(a){a.fillStyle="#554433";a.fillRect(this.x,this.y,this.width,this.height);if(this.hasBox)switch(this.boxType){case "bonus":this.drawHeart(a,this.x+this.width/2,this.y+this.height,BOX_SIZE);break;case "bullet":this.drawBullet(a,this.x+this.width/2,this.y+this.height+BOX_SIZE/2,BOX_SIZE/2);break;default:a.fillStyle=this.boxColor,a.fillRect(this.x+this.width/2-BOX_SIZE/2,this.y+this.height,BOX_SIZE,BOX_SIZE)}}drawHeart(a,b,c,d){a.fillStyle="green";a.beginPath();a.moveTo(b,
c+d/4);a.bezierCurveTo(b,c,b-d/2,c,b-d/2,c+d/4);a.bezierCurveTo(b-d/2,c+d/2,b,c+d/2,b,c+3*d/4);a.bezierCurveTo(b,c+d/2,b+d/2,c+d/2,b+d/2,c+d/4);a.bezierCurveTo(b+d/2,c,b,c,b,c+d/4);a.fill()}drawBullet(a,b,c,d){a.fillStyle="#CD7F32";a.beginPath();a.arc(b,c,d,0,2*Math.PI);a.fill();a.fillStyle="#DFA76C";a.beginPath();a.arc(b-.3*d,c-.3*d,.4*d,0,2*Math.PI);a.fill()}};class Box{constructor(a,b,c="normal",d=null){this.gridX=a;this.gridY=b;this.x=this.gridX*BOX_SIZE;this.y=this.gridY*BOX_SIZE;this.height=this.width=BOX_SIZE;this.velocityY=2;this.falling=!0;this.type=c;this.color=d||this.getRandomColor()}getRandomColor(){if("normal"!==this.type)return null;const a=["red","lime","green","purple"];return a[Math.floor(Math.random()*a.length)]}update(a,b,c){this.falling?(this.y+=50*this.velocityY*c,this.gridY=Math.floor(this.y/BOX_SIZE),(a=getBoxAt(this.gridX,this.gridY+
1,a))&&this.y+BOX_SIZE>a.y?(this.y=a.y-BOX_SIZE,this.gridY=a.gridY-1,this.falling=!1):this.gridY>=GRID_HEIGHT-1&&(this.y=(GRID_HEIGHT-1)*BOX_SIZE,this.gridY=GRID_HEIGHT-1,this.falling=!1)):!getBoxAt(this.gridX,this.gridY+1,a)&&this.gridY<GRID_HEIGHT-1&&(this.falling=!0);if(this.gridX===b.gridX&&this.gridY===b.gridY-1){if("bonus"===this.type)return b.addLife(),!0;if("bullet"===this.type){if(!b.hasBullet)return b.hasBullet=!0}else if(!b.invulnerable)return b.loseLife(),!0}this.x=this.gridX*BOX_SIZE;
return!1}draw(a){switch(this.type){case "bonus":this.drawHeart(a);break;case "bullet":this.drawBullet(a);break;default:a.fillStyle=this.color,a.fillRect(this.x,this.y,this.width,this.height)}}drawHeart(a){const b=this.x+this.width/2,c=this.y+this.height/2,d=.8*Math.min(this.width,this.height);a.fillStyle="green";a.beginPath();a.moveTo(b,c+d/4);a.bezierCurveTo(b,c,b-d/2,c,b-d/2,c-d/4);a.bezierCurveTo(b-d/2,c-d/2,b,c-d/2,b,c-d/4);a.bezierCurveTo(b,c-d/2,b+d/2,c-d/2,b+d/2,c-d/4);a.bezierCurveTo(b+d/
2,c,b,c,b,c+d/4);a.fill()}drawBullet(a){const b=this.x+this.width/2,c=this.y+this.height/2,d=.4*Math.min(this.width,this.height);a.fillStyle="#CD7F32";a.beginPath();a.arc(b,c,d,0,2*Math.PI);a.fill();a.fillStyle="#DFA76C";a.beginPath();a.arc(b-.3*d,c-.3*d,.4*d,0,2*Math.PI);a.fill()}};class Bullet{constructor(a,b,c){this.gridX=a;this.gridY=b;this.x=this.gridX*BOX_SIZE+BOX_SIZE/2;this.y=this.gridY*BOX_SIZE+BOX_SIZE/2;this.direction=c;this.speed=500;this.radius=5}update(a){this.x+=this.direction*this.speed*a;this.gridX=Math.floor(this.x/BOX_SIZE)}draw(a){a.fillStyle="yellow";a.beginPath();a.arc(this.x,this.y,this.radius,0,2*Math.PI);a.fill()}checkCollision(a){for(let b of a)if(b.gridX===this.gridX&&b.gridY===this.gridY)return b;return null}};
