const translations={en:{startGame:"Start Game",gameOver:"Game Over",finalScore:"Final Score",highScore:"High Score",playAgain:"Play Again",pause:"PAUSE",resume:"Press 'H' or 'P' to resume",toggleSound:"Press 'M' to toggle music",score:"Score",level:"Level",jump:"Jump",shoot:"Shoot",gameDescription:"Super Stack Attack is an exciting game where you control a character avoiding falling boxes and collecting bonuses. Your goal is to survive as long as possible and score the maximum points.",instructions:"Instructions",
moveLeft:"Use left arrow or A to move left",moveRight:"Use right arrow or D to move right",jumpKey:"Press space or W or up arrow to jump",collectHeart:"Collect hearts for extra lives",collectBullet:"Collect yellow spheres to get bullets",shootLeft:"Press ',' to shoot left",shootRight:"Press '.' to shoot right",collectLines:"Destroy entire lines of boxes of any color",destroyRows:"Destroy rows or lines of three or more same-colored boxes",pauseKey:"Press 'H' to pause/resume the game",soundKey:"Press 'M' to toggle music",
goodLuck:"Good luck and have fun!",contactLine:'Contact me by <a href="mailto:kosmosoid88@gmail.com">gmail.com</a> or donate me on <a href="https://boosty.to/kosmosoid" target="_blank">boosty.to</a>'},ru:{startGame:"\u041d\u0430\u0447\u0430\u0442\u044c \u0438\u0433\u0440\u0443",gameOver:"\u0418\u0433\u0440\u0430 \u043e\u043a\u043e\u043d\u0447\u0435\u043d\u0430",finalScore:"\u0424\u0438\u043d\u0430\u043b\u044c\u043d\u044b\u0439 \u0441\u0447\u0451\u0442",highScore:"\u041b\u0443\u0447\u0448\u0438\u0439 \u0441\u0447\u0451\u0442",
playAgain:"\u0418\u0433\u0440\u0430\u0442\u044c \u0441\u043d\u043e\u0432\u0430",pause:"\u041f\u0410\u0423\u0417\u0410",resume:"\u041d\u0430\u0436\u043c\u0438\u0442\u0435 'H' \u0438\u043b\u0438 'P' \u0434\u043b\u044f \u043f\u0440\u043e\u0434\u043e\u043b\u0436\u0435\u043d\u0438\u044f",toggleSound:"\u041d\u0430\u0436\u043c\u0438\u0442\u0435 'M' \u0434\u043b\u044f \u0432\u043a\u043b/\u0432\u044b\u043a\u043b \u043c\u0443\u0437\u044b\u043a\u0438",score:"\u041e\u0447\u043a\u0438",level:"\u0423\u0440\u043e\u0432\u0435\u043d\u044c",
jump:"\u041f\u0440\u044b\u0436\u043e\u043a",shoot:"\u0421\u0442\u0440\u0435\u043b\u044f\u0442\u044c",gameDescription:"Super Stack Attack - \u044d\u0442\u043e \u0443\u0432\u043b\u0435\u043a\u0430\u0442\u0435\u043b\u044c\u043d\u0430\u044f \u0438\u0433\u0440\u0430, \u0432 \u043a\u043e\u0442\u043e\u0440\u043e\u0439 \u0432\u044b \u0443\u043f\u0440\u0430\u0432\u043b\u044f\u0435\u0442\u0435 \u043f\u0435\u0440\u0441\u043e\u043d\u0430\u0436\u0435\u043c, \u0443\u043a\u043b\u043e\u043d\u044f\u044e\u0449\u0438\u043c\u0441\u044f \u043e\u0442 \u043f\u0430\u0434\u0430\u044e\u0449\u0438\u0445 \u044f\u0449\u0438\u043a\u043e\u0432 \u0438 \u0441\u043e\u0431\u0438\u0440\u0430\u044e\u0449\u0438\u043c \u0431\u043e\u043d\u0443\u0441\u044b. \u0412\u0430\u0448\u0430 \u0446\u0435\u043b\u044c - \u0441\u043e\u0431\u0438\u0440\u0430\u0442\u044c \u044f\u0449\u0438\u043a\u0438 \u0432 \u043b\u0438\u043d\u0438\u0438, \u043f\u0440\u043e\u0434\u0435\u0440\u0436\u0430\u0442\u044c\u0441\u044f \u043a\u0430\u043a \u043c\u043e\u0436\u043d\u043e \u0434\u043e\u043b\u044c\u0448\u0435 \u0438 \u043d\u0430\u0431\u0440\u0430\u0442\u044c \u043c\u0430\u043a\u0441\u0438\u043c\u0430\u043b\u044c\u043d\u043e\u0435 \u043a\u043e\u043b\u0438\u0447\u0435\u0441\u0442\u0432\u043e \u043e\u0447\u043a\u043e\u0432.",
instructions:"\u0418\u043d\u0441\u0442\u0440\u0443\u043a\u0446\u0438\u0438",moveLeft:"\u0421\u0442\u0440\u0435\u043b\u043a\u0430 \u0432\u043b\u0435\u0432\u043e \u0438\u043b\u0438 A \u0434\u043b\u044f \u0434\u0432\u0438\u0436\u0435\u043d\u0438\u044f \u0432\u043b\u0435\u0432\u043e",moveRight:"\u0421\u0442\u0440\u0435\u043b\u043a\u0430 \u0432\u043f\u0440\u0430\u0432\u043e \u0438\u043b\u0438 D \u0434\u043b\u044f \u0434\u0432\u0438\u0436\u0435\u043d\u0438\u044f \u0432\u043f\u0440\u0430\u0432\u043e",jumpKey:"\u0421\u0442\u0440\u0435\u043b\u043a\u0430 \u0432\u0432\u0435\u0440\u0445, W \u0438\u043b\u0438 \u043f\u0440\u043e\u0431\u0435\u043b \u0434\u043b\u044f \u043f\u0440\u044b\u0436\u043a\u0430",
shootLeft:"\u041d\u0430\u0436\u043c\u0438\u0442\u0435 ',' \u0434\u043b\u044f \u0441\u0442\u0440\u0435\u043b\u044c\u0431\u044b \u0432\u043b\u0435\u0432\u043e",shootRight:"\u041d\u0430\u0436\u043c\u0438\u0442\u0435 '.' \u0434\u043b\u044f \u0441\u0442\u0440\u0435\u043b\u044c\u0431\u044b \u0432\u043f\u0440\u0430\u0432\u043e",collectHeart:"\u0421\u043e\u0431\u0438\u0440\u0430\u0439\u0442\u0435 \u0441\u0435\u0440\u0434\u0446\u0430 \u0434\u043b\u044f \u043f\u043e\u043b\u0443\u0447\u0435\u043d\u0438\u044f \u0434\u043e\u043f\u043e\u043b\u043d\u0438\u0442\u0435\u043b\u044c\u043d\u044b\u0445 \u0436\u0438\u0437\u043d\u0435\u0439",
collectBullet:"\u0421\u043e\u0431\u0438\u0440\u0430\u0439\u0442\u0435 \u0448\u0430\u0440\u0438\u043a\u0438 \u0434\u043b\u044f \u043f\u043e\u043b\u0443\u0447\u0435\u043d\u0438\u044f \u043f\u0443\u043b\u044c",collectLines:"\u0423\u043d\u0438\u0447\u0442\u043e\u0436\u0430\u0439\u0442\u0435 \u0446\u0435\u043b\u044b\u0435 \u043b\u0438\u043d\u0438\u0438 \u0438\u0437 \u044f\u0449\u0438\u043a\u043e\u0432 \u043b\u044e\u0431\u044b\u0445 \u0446\u0432\u0435\u0442\u043e\u0432",destroyRows:"\u0423\u043d\u0438\u0447\u0442\u043e\u0436\u0430\u0439\u0442\u0435 \u0440\u044f\u0434\u044b \u0438\u0437 \u0442\u0440\u0435\u0445 \u0438 \u0431\u043e\u043b\u0435\u0435 \u043e\u0434\u0438\u043d\u0430\u043a\u043e\u0432\u044b\u0445 \u044f\u0449\u0438\u043a\u043e\u0432",
pauseKey:"\u041d\u0430\u0436\u043c\u0438\u0442\u0435 'H' \u0438\u043b\u0438 'P' \u0434\u043b\u044f \u043f\u0430\u0443\u0437\u044b/\u0432\u043e\u0437\u043e\u0431\u043d\u043e\u0432\u043b\u0435\u043d\u0438\u044f \u0438\u0433\u0440\u044b",soundKey:"\u041d\u0430\u0436\u043c\u0438\u0442\u0435 'M' \u0434\u043b\u044f \u0432\u043a\u043b\u044e\u0447\u0435\u043d\u0438\u044f/\u0432\u044b\u043a\u043b\u044e\u0447\u0435\u043d\u0438\u044f \u043c\u0443\u0437\u044b\u043a\u0438",goodLuck:"\u0423\u0434\u0430\u0447\u0438 \u0438 \u0432\u0435\u0441\u0435\u043b\u043e\u0439 \u0438\u0433\u0440\u044b!",
contactLine:'\u0421\u0432\u044f\u0437\u0430\u0442\u044c\u0441\u044f \u0441\u043e \u043c\u043d\u043e\u0439 \u043f\u043e <a href="mailto:kosmosoid88@gmail.com">gmail.com</a> \u0438\u043b\u0438 \u043f\u043e\u0434\u0434\u0435\u0440\u0436\u0430\u0442\u044c \u043c\u0435\u043d\u044f \u043d\u0430 <a href="https://boosty.to/kosmosoid" target="_blank">boosty.to</a>'}},language=navigator.language.startsWith("ru")?"ru":"en";function t(a){return translations[language][a]||a}
function addMobileControls(){const a=document.createElement("div");a.id="controlsContainer";a.style.position="fixed";a.style.bottom="0";a.style.left="0";a.style.width="100%";a.style.height=CONTROL_HEIGHT+"px";a.style.backgroundColor="#f0f0f0";document.body.appendChild(a);const b=document.createElement("button");b.textContent="\u25c0\ufe0f";b.className="mobile-control left";const c=document.createElement("button");c.textContent="\ud83d\udd2b";c.className="mobile-control shoot";const d=document.createElement("button");
d.textContent="\ud83d\udd3c";d.className="mobile-control jump";const e=document.createElement("button");e.textContent="\u25b6\ufe0f";e.className="mobile-control right";a.appendChild(b);a.appendChild(c);a.appendChild(d);a.appendChild(e);b.addEventListener("touchstart",g=>{g.preventDefault();player.moveOnce(-1,boxes)});e.addEventListener("touchstart",g=>{g.preventDefault();player.moveOnce(1,boxes)});d.addEventListener("touchstart",g=>{g.preventDefault();player.jump()});c.addEventListener("touchstart",
g=>{g.preventDefault();player.hasBullet&&(g=player.shoot(player.lastDirection))&&(bullets.push(g),playSound(AUDIO.shoot))})}function setCookie(a,b,c){var d="";c&&(d=new Date,d.setTime(d.getTime()+864E5*c),d="; expires="+d.toUTCString());document.cookie=a+"="+(b||"")+d+"; path=/"}
function getCookie(a){a+="=";const b=document.cookie.split(";");for(let c=0;c<b.length;c++){let d=b[c];for(;" "===d.charAt(0);)d=d.substring(1,d.length);if(0===d.indexOf(a))return d.substring(a.length,d.length)}return null}function eraseCookie(a){document.cookie=a+"=; Path=/; Expires=Thu, 01 Jan 1970 00:00:01 GMT;"}
const AUDIO={backgroundMusic:new Audio("sounds/background_music.mp3"),shoot:new Audio("sounds/shoot.wav"),loose:new Audio("sounds/loose.wav"),match:new Audio("sounds/match.wav"),line:new Audio("sounds/line.wav"),heartbeat:new Audio("sounds/heartbeat.wav")};let isSoundOn="true"===getCookie("isSoundOn");const BACKGROUND_MUSIC_VOLUME=.1;AUDIO.backgroundMusic.loop=!0;AUDIO.backgroundMusic.volume=BACKGROUND_MUSIC_VOLUME;
function playSound(a){a.currentTime=0;a.play().catch(b=>console.error("Error playing sound:",b))}function startBackgroundMusic(){isSoundOn&&AUDIO.backgroundMusic.play().catch(a=>console.error("Error playing background music:",a))}function stopBackgroundMusic(){AUDIO.backgroundMusic.pause();AUDIO.backgroundMusic.currentTime=0}function toggleSound(){isSoundOn=!isSoundOn;setCookie("isSoundOn",isSoundOn.toString(),365);isSoundOn?startBackgroundMusic():stopBackgroundMusic()}
function initAudio(){isSoundOn&&startBackgroundMusic()}function getBoxAt(a,b,c){return c.find(d=>d.gridX===a&&d.gridY===b)}function drawGrid(a,b,c,d){a.strokeStyle="rgba(0, 0, 0, 0.1)";for(var e=0;e<=b/d;e++)a.beginPath(),a.moveTo(e*d,0),a.lineTo(e*d,c),a.stroke();for(e=0;e<=c/d;e++)a.beginPath(),a.moveTo(0,e*d),a.lineTo(b,e*d),a.stroke()}const isMobile=/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);let WIDTH,HEIGHT,BOX_SIZE,CONTROL_HEIGHT;
isMobile?(WIDTH=640<window.innerWidth?640:window.innerWidth-window.innerWidth%25,CONTROL_HEIGHT=100,HEIGHT=480,BOX_SIZE=25):(WIDTH=640,HEIGHT=480,BOX_SIZE=40,CONTROL_HEIGHT=0);const startButton=document.getElementById("startButton"),canvas=document.getElementById("gameCanvas"),gameInfo=document.getElementById("gameInfo"),footer=document.getElementById("contacts"),ctx=canvas.getContext("2d");document.getElementById("startButton").textContent=t("startGame");footer.innerHTML=t("contactLine");
gameInfo.innerHTML=`
    <p>${t("gameDescription")}</p>
    <h3>${t("instructions")}</h3>
    <ul>
        <li>${t("moveLeft")}</li>
        <li>${t("moveRight")}</li>
        <li>${t("jumpKey")}</li>
        <li>${t("shootLeft")}</li>
        <li>${t("shootRight")}</li>
        <li>${t("collectHeart")}</li>
        <li>${t("collectBullet")}</li>
        <li>${t("collectLines")}</li>
        <li>${t("destroyRows")}</li>
        <li>${t("pauseKey")}</li>
        <li>${t("soundKey")}</li>
    </ul>
    <p>${t("goodLuck")}</p>
`;startButton.addEventListener("click",()=>{gameInfo.style.display="none";canvas.style.display="block";startButton.style.display="none";initGame();lastTime=performance.now();animationFrameId=requestAnimationFrame(gameLoop)});window.addEventListener("resize",()=>{isMobile&&(WIDTH=window.innerWidth,HEIGHT=window.innerHeight-CONTROL_HEIGHT,GRID_WIDTH=Math.floor(WIDTH/BOX_SIZE),GRID_HEIGHT=Math.floor(HEIGHT/BOX_SIZE),canvas.width=WIDTH,canvas.height=HEIGHT)});const backgroundImages="images/background1.png images/background2.png images/background3.png images/background4.png images/background5.png images/background6.png images/background7.png images/background8.png images/background9.png images/background10.png images/background11.png images/background12.png images/background13.png".split(" ");
function changeBackground(){currentBackgroundIndex++;12<currentBackgroundIndex&&(currentBackgroundIndex=1);canvas.style.backgroundImage=`url('${backgroundImages[currentBackgroundIndex]}')`}const PLAYER_SIZE=BOX_SIZE,CRANE_WIDTH=2*BOX_SIZE,CRANE_HEIGHT=BOX_SIZE/2;let GRID_WIDTH=Math.floor(WIDTH/BOX_SIZE),GRID_HEIGHT=Math.floor(HEIGHT/BOX_SIZE);canvas.width=WIDTH;canvas.height=HEIGHT;
let player,crane,boxes=[],bullets=[],gameOver=!1,score=0,level=1,lastLifeBonus=0,isPaused=!1,animationFrameId=null,lastTime=0,currentBackgroundIndex=-1,gameInProgress=!1,highScore=parseInt(getCookie("highScore"))||0;
function initGame(){canvas.width=WIDTH;canvas.height=HEIGHT;player=new Player(Math.floor(GRID_WIDTH/2),GRID_HEIGHT-1);crane=new Crane;boxes=[];bullets=[];gameOver=!1;score=0;level=1;lastLifeBonus=0;isPaused=!1;gameInProgress=!0;gameInfo.style.display="none";canvas.style.display="block";highScore=parseInt(getCookie("highScore"))||0;isMobile&&addMobileControls();initAudio();changeBackground()}
document.addEventListener("keydown",a=>{if("KeyM"===a.code)toggleSound();else if("KeyS"===a.code&&gameOver)initGame(),changeBackground(),animationFrameId=requestAnimationFrame(gameLoop);else if(("KeyP"===a.code||"KeyH"===a.code)&&gameInProgress)(isPaused=!isPaused)?(animationFrameId&&(cancelAnimationFrame(animationFrameId),animationFrameId=null),stopBackgroundMusic(),drawPauseScreen()):(animationFrameId||(animationFrameId=requestAnimationFrame(gameLoop)),startBackgroundMusic());else if(!isPaused)switch(a.code){case "ArrowLeft":case "KeyA":player.move(-1,
boxes);break;case "ArrowRight":case "KeyD":player.move(1,boxes);break;case "Space":case "KeyW":case "ArrowUp":player.jump();break;case "Comma":if(a=player.shoot(-1))bullets.push(a),playSound(AUDIO.shoot);break;case "Period":if(a=player.shoot(1))bullets.push(a),playSound(AUDIO.shoot)}});document.addEventListener("keyup",a=>{"ArrowLeft"!==a.code&&"ArrowRight"!==a.code||player.stopMoving()});
function enableFullscreen(){const a=document.getElementById("gameContainer");a.requestFullscreen?a.requestFullscreen():a.mozRequestFullScreen?a.mozRequestFullScreen():a.webkitRequestFullscreen?a.webkitRequestFullscreen():a.msRequestFullscreen&&a.msRequestFullscreen()}function updateHighScore(){score>highScore&&(highScore=score,setCookie("highScore",highScore,365))}
function drawPauseScreen(){ctx.fillStyle="rgba(0, 0, 0, 0.5)";ctx.fillRect(0,0,WIDTH,HEIGHT);ctx.fillStyle="white";ctx.font="30px Arial";ctx.textAlign="center";ctx.fillText(t("pause"),WIDTH/2,HEIGHT/2);ctx.font="20px Arial";ctx.fillText(t("resume"),WIDTH/2,HEIGHT/2+40);ctx.fillText(t("toggleSound"),WIDTH/2,HEIGHT/2+70)}function removeBoxAndUpdateStack(a){boxes=boxes.filter(b=>b!==a);boxes.filter(b=>b.gridX===a.gridX&&b.gridY<a.gridY).forEach(b=>{b.gridY++;b.falling=!0})}
function checkAndClearLines(){let a=0;for(let b=GRID_HEIGHT-1;0<=b;b--)boxes.filter(c=>c.gridY===b).length===GRID_WIDTH&&(boxes=boxes.filter(c=>c.gridY!==b),boxes.forEach(c=>{c.gridY<b&&(c.gridY++,c.falling=!0)}),a++,playSound(AUDIO.line),b++);score+=5*a;checkLevelUp();checkLifeBonus()}
function checkAndClearMatches(){let a=new Set;for(let e=0;e<GRID_HEIGHT;e++)for(let g=0;g<GRID_WIDTH-2;g++){var b=boxes.find(f=>f.gridX===g&&f.gridY===e&&"normal"===f.type&&!f.falling),c=boxes.find(f=>f.gridX===g+1&&f.gridY===e&&"normal"===f.type&&!f.falling),d=boxes.find(f=>f.gridX===g+2&&f.gridY===e&&"normal"===f.type&&!f.falling);b&&c&&d&&b.color===c.color&&c.color===d.color&&(a.add(b),a.add(c),a.add(d))}for(let e=0;e<GRID_WIDTH;e++)for(let g=0;g<GRID_HEIGHT-2;g++)b=boxes.find(f=>f.gridX===e&&
f.gridY===g&&"normal"===f.type&&!f.falling),c=boxes.find(f=>f.gridX===e&&f.gridY===g+1&&"normal"===f.type&&!f.falling),d=boxes.find(f=>f.gridX===e&&f.gridY===g+2&&"normal"===f.type&&!f.falling),b&&c&&d&&b.color===c.color&&c.color===d.color&&(a.add(b),a.add(c),a.add(d));0<a.size&&(boxes=boxes.filter(e=>!a.has(e)),playSound(AUDIO.match),boxes.forEach(e=>{const g=Array.from(a).filter(f=>f.gridX===e.gridX&&f.gridY>e.gridY);e.gridY+=g.length;e.falling=!0}),score+=3*a.size,checkLevelUp(),checkLifeBonus())}
function checkLevelUp(){score>=20*level&&(level++,crane.increaseSpeed())}function checkLifeBonus(){100<=score-lastLifeBonus&&(player.addLife(),lastLifeBonus=score-score%100)}function drawScore(){ctx.save();ctx.fillStyle="white";ctx.font="bold 16px Arial";ctx.textAlign="left";ctx.textBaseline="top";ctx.fillStyle="rgba(0, 0, 0, 0.2)";ctx.fillRect(10,22,120,46);ctx.fillStyle="white";ctx.fillText(`${t("score")}: ${score}`,16,28);ctx.fillText(`${t("level")}: ${level}`,16,48);ctx.restore()}
function drawGameOverScreen(){ctx.fillStyle="rgba(0, 0, 0, 0.7)";ctx.fillRect(0,0,WIDTH,HEIGHT);ctx.fillStyle="white";ctx.font="30px Arial";ctx.textAlign="center";ctx.fillText(t("gameOver"),WIDTH/2,HEIGHT/2-60);ctx.fillText(`${t("finalScore")}: ${score}`,WIDTH/2,HEIGHT/2-30);ctx.fillText(`${t("highScore")}: ${score}`,WIDTH/2,HEIGHT/2);ctx.font="20px Arial";ctx.fillText(t("toggleSound"),WIDTH/2,HEIGHT/2+50)}
function gameLoop(a){const b=(a-lastTime)/1E3;lastTime=a;gameOver?(stopBackgroundMusic(),drawGameOverScreen(),updateHighScore(),startButton.style.display="block",startButton.textContent=t("playAgain")):(isPaused?drawPauseScreen():(ctx.clearRect(0,0,WIDTH,HEIGHT),player.update(boxes,b),(a=crane.update(boxes,b))&&boxes.push(a),boxes=boxes.filter(c=>!c.update(boxes,player,b)),bullets=bullets.filter(c=>{c.update(b);const d=c.checkCollision(boxes);return d?(removeBoxAndUpdateStack(d),!1):0<=c.gridX&&c.gridX<
GRID_WIDTH}),checkAndClearLines(),checkAndClearMatches(),ctx.fillStyle="rgba(255, 255, 255, 0.1)",ctx.fillRect(0,0,WIDTH,HEIGHT),drawGrid(ctx,WIDTH,HEIGHT,BOX_SIZE),boxes.forEach(c=>c.draw(ctx)),player.draw(ctx),crane.draw(ctx),bullets.forEach(c=>c.draw(ctx)),drawScore()),animationFrameId=requestAnimationFrame(gameLoop))}
class Box{constructor(a,b,c="normal",d=null){this.gridX=a;this.gridY=b;this.x=this.gridX*BOX_SIZE;this.y=this.gridY*BOX_SIZE;this.height=this.width=BOX_SIZE;this.velocityY=2;this.falling=!0;this.type=c;this.color=d||this.getRandomColor()}getRandomColor(){if("normal"!==this.type)return null;const a=["red","lime","green","purple"];return a[Math.floor(Math.random()*a.length)]}update(a,b,c){this.falling?(this.y+=50*this.velocityY*c,this.gridY=Math.floor(this.y/BOX_SIZE),(a=getBoxAt(this.gridX,this.gridY+
1,a))&&this.y+BOX_SIZE>a.y?(this.y=a.y-BOX_SIZE,this.gridY=a.gridY-1,this.falling=!1):this.gridY>=GRID_HEIGHT-1&&(this.y=(GRID_HEIGHT-1)*BOX_SIZE,this.gridY=GRID_HEIGHT-1,this.falling=!1)):!getBoxAt(this.gridX,this.gridY+1,a)&&this.gridY<GRID_HEIGHT-1&&(this.falling=!0);if(this.gridX===b.gridX&&this.gridY===b.gridY-1){if("bonus"===this.type)return b.addLife(),!0;if("bullet"===this.type){if(!b.hasBullet)return b.hasBullet=!0}else if(!b.invulnerable)return b.loseLife(),!0}this.x=this.gridX*BOX_SIZE;
return!1}draw(a){switch(this.type){case "bonus":this.drawHeart(a);break;case "bullet":this.drawBullet(a);break;default:a.fillStyle=this.color,a.fillRect(this.x,this.y,this.width,this.height)}}drawHeart(a){const b=this.x+this.width/2,c=this.y+this.height/2,d=.8*Math.min(this.width,this.height);a.fillStyle="green";a.beginPath();a.moveTo(b,c+d/4);a.bezierCurveTo(b,c,b-d/2,c,b-d/2,c-d/4);a.bezierCurveTo(b-d/2,c-d/2,b,c-d/2,b,c-d/4);a.bezierCurveTo(b,c-d/2,b+d/2,c-d/2,b+d/2,c-d/4);a.bezierCurveTo(b+d/
2,c,b,c,b,c+d/4);a.fill()}drawBullet(a){const b=this.x+this.width/2,c=this.y+this.height/2,d=.4*Math.min(this.width,this.height);a.fillStyle="#CD7F32";a.beginPath();a.arc(b,c,d,0,2*Math.PI);a.fill();a.fillStyle="#DFA76C";a.beginPath();a.arc(b-.3*d,c-.3*d,.4*d,0,2*Math.PI);a.fill()}}
class Crane{constructor(){this.gridX=GRID_WIDTH;this.x=this.gridX*BOX_SIZE;this.y=0;this.width=CRANE_WIDTH;this.height=CRANE_HEIGHT;this.speed=this.baseSpeed=150;this.direction=-1;this.hasBox=!0;this.dropPoint=Math.floor(Math.random()*GRID_WIDTH);this.boxType=this.getRandomBoxType();this.boxColor=this.getRandomBoxColor()}update(a,b){this.x+=this.speed*this.direction*b;this.gridX=Math.floor(this.x/BOX_SIZE);-2>=this.gridX&&(this.gridX=GRID_WIDTH,this.x=this.gridX*BOX_SIZE,this.hasBox=!0,this.dropPoint=
Math.floor(Math.random()*GRID_WIDTH),this.boxType=this.getRandomBoxType(),this.boxColor=this.getRandomBoxColor());return this.hasBox&&Math.floor(this.x/BOX_SIZE)===this.dropPoint&&!a.some(c=>c.gridX===this.dropPoint&&0===c.gridY)?(this.hasBox=!1,new Box(this.dropPoint,0,this.boxType,this.boxColor)):null}getRandomBoxType(){const a=Math.random();return.1>a?"bonus":.2>a?"bullet":"normal"}getRandomBoxColor(){const a=["red","lime","green","purple"];return a[Math.floor(Math.random()*a.length)]}increaseSpeed(){this.speed=
this.baseSpeed*(1+.1*(level-1))}draw(a){a.fillStyle="#554433";a.fillRect(this.x,this.y,this.width,this.height);if(this.hasBox)switch(this.boxType){case "bonus":this.drawHeart(a,this.x+this.width/2,this.y+this.height,BOX_SIZE);break;case "bullet":this.drawBullet(a,this.x+this.width/2,this.y+this.height+BOX_SIZE/2,BOX_SIZE/2);break;default:a.fillStyle=this.boxColor,a.fillRect(this.x+this.width/2-BOX_SIZE/2,this.y+this.height,BOX_SIZE,BOX_SIZE)}}drawHeart(a,b,c,d){a.fillStyle="green";a.beginPath();a.moveTo(b,
c+d/4);a.bezierCurveTo(b,c,b-d/2,c,b-d/2,c+d/4);a.bezierCurveTo(b-d/2,c+d/2,b,c+d/2,b,c+3*d/4);a.bezierCurveTo(b,c+d/2,b+d/2,c+d/2,b+d/2,c+d/4);a.bezierCurveTo(b+d/2,c,b,c,b,c+d/4);a.fill()}drawBullet(a,b,c,d){a.fillStyle="#CD7F32";a.beginPath();a.arc(b,c,d,0,2*Math.PI);a.fill();a.fillStyle="#DFA76C";a.beginPath();a.arc(b-.3*d,c-.3*d,.4*d,0,2*Math.PI);a.fill()}}
class Player{constructor(a,b){this.gridX=a;this.gridY=b;this.x=this.gridX*BOX_SIZE;this.y=this.gridY*BOX_SIZE;this.height=this.width=PLAYER_SIZE;this.velocityY=0;this.jumpSpeed=-500;this.gravity=1E3;this.jumping=!1;this.lives=5;this.invulnerable=!1;this.invulnerabilityTime=0;this.invulnerabilityDuration=2;this.hasBullet=!1;this.movingDirection=0;this.lastDirection=1;this.moveTimer=0;this.moveSpeed=isMobile?1:5}move(a,b){const c=this.gridX+a;if(0<=c&&c<GRID_WIDTH){const d=this.getBoxAt(c,this.gridY,
b);d?this.canPushBox(d,a,b)&&(this.pushBox(d,a,b),this.gridX=c,this.x=this.gridX*BOX_SIZE):(this.gridX=c,this.x=this.gridX*BOX_SIZE)}}moveOnce(a,b){this.lastDirection=a;const c=this.gridX+a;if(0<=c&&c<GRID_WIDTH){const d=this.getBoxAt(c,this.gridY,b);d?this.canPushBox(d,a,b)&&(this.pushBox(d,a,b),this.gridX=c,this.x=this.gridX*BOX_SIZE):(this.gridX=c,this.x=this.gridX*BOX_SIZE)}}stopMoving(){this.movingDirection=0}jump(){this.jumping||(this.velocityY=this.jumpSpeed,this.jumping=!0)}shoot(a){if(!this.hasBullet)return null;
this.hasBullet=!1;return new Bullet(this.gridX,this.gridY,a)}getBoxAt(a,b,c){return c.find(d=>d.gridX===a&&d.gridY===b)}update(a,b){this.velocityY+=this.gravity*b;this.y+=this.velocityY*b;0!==this.movingDirection&&this.move(this.movingDirection,a);isMobile||0===this.movingDirection||this.moveOnce(this.movingDirection,a);if(this.y>this.gridY*BOX_SIZE){if(this.getBoxAt(this.gridX,this.gridY+1,a)||this.gridY>=GRID_HEIGHT-1)this.y=this.gridY*BOX_SIZE,this.velocityY=0,this.jumping=!1}else(a=this.getBoxAt(this.gridX,
this.gridY-1,a))&&this.y<=a.y+BOX_SIZE&&(this.y=this.gridY*BOX_SIZE,this.velocityY=0);this.gridY=Math.floor(this.y/BOX_SIZE);this.invulnerable&&(this.invulnerabilityTime+=b,this.invulnerabilityTime>=this.invulnerabilityDuration&&(this.invulnerable=!1,this.invulnerabilityTime=0))}canPushBox(a,b,c){b=a.gridX+b;return 0<=b&&b<GRID_WIDTH&&!getBoxAt(b,a.gridY,c)&&!getBoxAt(a.gridX,a.gridY-1,c)}pushBox(a,b,c){a.gridX+=b;a.x=a.gridX*BOX_SIZE;!getBoxAt(a.gridX,a.gridY+1,c)&&a.gridY<GRID_HEIGHT-1&&(a.falling=
!0)}addLife(){10>this.lives&&(this.lives++,playSound(AUDIO.heartbeat))}loseLife(){this.invulnerable||(this.lives--,playSound(AUDIO.loose),this.invulnerable=!0,this.invulnerabilityTime=0,0>=this.lives&&(gameOver=!0,gameInProgress=!1))}drawHeart(a,b,c,d,e){a.fillStyle=e;a.beginPath();a.moveTo(b,c+d/4);a.bezierCurveTo(b,c,b-d/2,c,b-d/2,c+d/4);a.bezierCurveTo(b-d/2,c+d/2,b,c+d/2,b,c+3*d/4);a.bezierCurveTo(b,c+d/2,b+d/2,c+d/2,b+d/2,c+d/4);a.bezierCurveTo(b+d/2,c,b,c,b,c+d/4);a.fill()}draw(a){a.fillStyle=
this.invulnerable?"rgba(0, 0, 255, 0.5)":"blue";a.fillRect(this.x,this.y,this.width,this.height);for(var b=0;b<this.lives;b++)this.drawHeart(a,25+30*b,5,20,"green");this.hasBullet&&(b=WIDTH-25,a.fillStyle="#CD7F32",a.beginPath(),a.arc(b,25,10,0,2*Math.PI),a.fill(),a.fillStyle="#DFA76C",a.beginPath(),a.arc(b-3,22,4,0,2*Math.PI),a.fill())}}
class Bullet{constructor(a,b,c){this.gridX=a;this.gridY=b;this.x=this.gridX*BOX_SIZE+BOX_SIZE/2;this.y=this.gridY*BOX_SIZE+BOX_SIZE/2;this.direction=c;this.speed=500;this.radius=5}update(a){this.x+=this.direction*this.speed*a;this.gridX=Math.floor(this.x/BOX_SIZE)}draw(a){a.fillStyle="yellow";a.beginPath();a.arc(this.x,this.y,this.radius,0,2*Math.PI);a.fill()}checkCollision(a){for(let b of a)if(b.gridX===this.gridX&&b.gridY===this.gridY)return b;return null}};
